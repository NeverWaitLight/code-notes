# Story 1.2: 上传接口与元数据落库

## Status
Done

## Story
**As a** 使用者,
**I want** 上传视频并生成元数据记录，
**so that** 系统可追踪上传状态与基础信息。

## Epic Context
Epic 1 目标是完成“基础架构与上传处理闭环”。本 Story 负责上传入口与元数据落库，为后续分片处理与播放提供基础数据与状态。[Source: docs/prd/epic-1-基础架构与上传处理闭环.md#epic-1-基础架构与上传处理闭环]

## Dependencies
依赖 Story 1.1 已完成基础工程、SQLite 与本地存储配置。

## Acceptance Criteria
1. 提供上传接口（multipart/form-data），支持上传 MP4（H.264）且大小 ≤ 5GB。
2. 上传成功后将原始视频保存到本地文件系统，生成唯一 ID。
3. 将视频元数据写入 SQLite（标题、原始文件名、大小、状态、创建时间、存储路径）。
4. 初始状态为“上传中”，失败时记录错误提示。
5. 提供视频列表查询接口，返回必要字段与状态。

## Tasks / Subtasks
- [x] Task 1 建模与持久化：实现 Video 实体与 Repository，字段与表结构对齐（AC:3）[Source: docs/architecture/data-models.md#video][Source: docs/architecture/database-schema.md#database-schema][Source: docs/architecture/backend-architecture.md#data-access-layer]
  - [x] Subtask 1.1 实体字段覆盖 title、originalFilename、sizeBytes、status、errorCode、errorMessage、storagePath、createdAt、updatedAt（AC:3,4）[Source: docs/architecture/data-models.md#video]
  - [x] Subtask 1.2 表名与字段映射到 `t_videos` 结构（AC:3）[Source: docs/architecture/database-schema.md#database-schema]
- [x] Task 2 实现上传接口 `POST /api/videos`（AC:1,2,3,4）[Source: docs/architecture/api-specification.md#endpoint-details][Source: docs/architecture/backend-architecture.md#controller-template]
  - [x] Subtask 2.1 接收 `file` 与 `title`，校验请求参数与媒体类型（AC:1,4）[Source: docs/architecture/api-specification.md#endpoint-details][Source: docs/architecture/error-handling-strategy.md#error-code-catalog]
  - [x] Subtask 2.2 保存原始文件到本地存储根目录下并记录 `storagePath`（AC:2,3）[Source: docs/architecture/data-models.md#video][Source: docs/architecture/development-workflow.md#required-environment-variables]
  - [x] Subtask 2.3 创建 Video 元数据记录，初始 `status=UPLOADING`，返回 201 与 DTO 字段（AC:3,4）[Source: docs/architecture/api-specification.md#endpoint-details][Source: docs/architecture/data-models.md#video]
  - [x] Subtask 2.4 通过 multipart 配置与上传大小限制实现 ≤ 5GB 约束，超限返回 `UPLOAD_TOO_LARGE`（AC:1,4）[Source: docs/architecture/development-workflow.md#required-environment-variables][Source: docs/architecture/error-handling-strategy.md#error-code-catalog]
- [x] Task 3 实现列表接口 `GET /api/videos`（AC:5）[Source: docs/architecture/api-specification.md#endpoint-details][Source: docs/architecture/backend-architecture.md#controller-template]
  - [x] Subtask 3.1 返回字段：id、title、status、sizeBytes、createdAt（AC:5）[Source: docs/architecture/api-specification.md#dto-definitions]
- [x] Task 4 失败处理与错误响应格式（AC:4）[Source: docs/architecture/error-handling-strategy.md#error-response-format][Source: docs/architecture/error-handling-strategy.md#error-code-catalog]
  - [x] Subtask 4.1 上传失败时记录 `errorCode` 与 `errorMessage`，并返回 `{ error: { code, message } }`（AC:4）[Source: docs/architecture/data-models.md#video][Source: docs/architecture/coding-standards.md#critical-fullstack-rules]
  - [x] Subtask 4.2 处理 `INVALID_REQUEST`、`INVALID_MEDIA_TYPE`、`UPLOAD_TOO_LARGE`、`STORAGE_IO_ERROR` 等错误码（AC:1,4）[Source: docs/architecture/error-handling-strategy.md#error-code-catalog][Source: docs/architecture/api-specification.md#endpoint-details]
- [x] Task 5 测试与验证（AC:1,3,5）[Source: docs/architecture/testing-strategy.md#testing-strategy]
  - [x] Subtask 5.1 Controller/Service 层测试覆盖上传成功、参数非法、媒体类型不符、超限与列表返回字段（AC:1,3,4,5）[Source: docs/architecture/testing-strategy.md#test-organization]
  - [x] Subtask 5.2 验证上传后 `t_videos` 记录可读写（AC:3,5）[Source: docs/architecture/local-validation.md#jpa--sqlite]

## Dev Notes
### Previous Story Insights
不适用：本 Story 不依赖前序实现的额外注意事项。

### Data Models
- Video 字段：id、title、originalFilename、sizeBytes、status（UPLOADING/READY/FAILED）、errorCode、errorMessage、storagePath、createdAt、updatedAt。[Source: docs/architecture/data-models.md#video]
- `t_videos` 表结构：`id`（自增主键）、`title`（NOT NULL）、`original_filename`（NOT NULL）、`size_bytes`（NOT NULL）、`status`（NOT NULL，限定 UPLOADING/READY/FAILED）、`error_code`（可空）、`error_message`（可空）、`storage_path`（NOT NULL）、`created_at`（NOT NULL）、`updated_at`（NOT NULL）。[Source: docs/architecture/database-schema.md#database-schema]

### API Specifications
- `POST /api/videos`：multipart/form-data，字段 `file`（MP4 H.264）与 `title`；成功返回 201 与 `id/title/status/sizeBytes/createdAt`。[Source: docs/architecture/api-specification.md#endpoint-details]
- `GET /api/videos`：返回列表项 `id/title/status/sizeBytes/createdAt`。[Source: docs/architecture/api-specification.md#dto-definitions]
- 错误响应格式：`{ error: { code, message, details?, timestamp, requestId } }`。[Source: docs/architecture/error-handling-strategy.md#error-response-format]
- 相关错误码：`INVALID_REQUEST`、`INVALID_MEDIA_TYPE`、`UPLOAD_TOO_LARGE`、`STORAGE_IO_ERROR`。[Source: docs/architecture/error-handling-strategy.md#error-code-catalog]

### Component Specifications
- 控制器与服务位置：`controller/VideoController.java`、`service/VideoService.java`；仓库 `repository/VideoRepository.java`。[Source: docs/architecture/backend-architecture.md#controllerroute-organization]

### File Locations
- 后端包路径：`backend/src/main/java/com/example/videodemo/`；资源目录 `backend/src/main/resources/`。[Source: docs/architecture/unified-project-structure.md#unified-project-structure]
- 后端分层目录：`controller/`、`service/`、`repository/`、`entity/`、`config/`。[Source: docs/architecture/backend-architecture.md#controllerroute-organization]

### Configuration
- 上传与存储相关环境变量：`APP_STORAGE_ROOT`、`APP_UPLOAD_MAX_BYTES`、`SPRING_SERVLET_MULTIPART_MAX_FILE_SIZE`、`SPRING_SERVLET_MULTIPART_MAX_REQUEST_SIZE`、`SPRING_SERVLET_MULTIPART_FILE_SIZE_THRESHOLD`、`SPRING_SERVLET_MULTIPART_LOCATION`。[Source: docs/architecture/development-workflow.md#required-environment-variables]
- SQLite 数据库路径：`APP_DB_PATH=./data/app.db`。[Source: docs/architecture/development-workflow.md#required-environment-variables]
- 上传大小上限通过 multipart 配置与 `APP_UPLOAD_MAX_BYTES` 限制，超限需返回 `UPLOAD_TOO_LARGE`。[Source: docs/architecture/development-workflow.md#required-environment-variables][Source: docs/architecture/error-handling-strategy.md#error-code-catalog]

### Testing
- 后端测试目录：`backend/src/test/java/com/example/videodemo/`；使用 JUnit 5 + Spring Boot Test。[Source: docs/architecture/testing-strategy.md#test-organization]
- 仅需 Unit + Integration + 手工冒烟，不引入 E2E。[Source: docs/architecture/tech-stack.md#关键选型与推荐请确认]

### Technical Constraints
- 错误格式必须返回 `{ error: { code, message } }`。[Source: docs/architecture/coding-standards.md#critical-fullstack-rules]
- 上传接口仅负责入库与落盘，切片处理异步在后续 Story 实现。[Source: docs/architecture/coding-standards.md#critical-fullstack-rules]
- 存储路径通过配置读取，不允许硬编码。[Source: docs/architecture/coding-standards.md#critical-fullstack-rules]
- 后端技术栈：Spring Boot 3.2.x + JPA + SQLite + Java 21。[Source: docs/architecture/tech-stack.md#technology-stack-table]

## Project Structure Notes
- 与 `Unified Project Structure` 对齐：`backend/`、`frontend/`、`data/`、`docs/` 与 `startup.sh` 已定义。[Source: docs/architecture/unified-project-structure.md#unified-project-structure]

## Change Log
| Date       | Version | Description       | Author |
| ---------- | ------- | ----------------- | ------ |
| 2026-01-15 | v0.4    | Fix multipart missing file handling and test updates | James  |
| 2026-01-15 | v0.3    | Address review feedback and extend tests | James  |
| 2026-01-15 | v0.2    | Implement upload/list APIs and tests        | James  |
| 2026-01-15 | v0.1    | 创建 Story 1.2 草稿 | Bob    |

## Dev Agent Record
### Agent Model Used
GPT-5

### Debug Log References
None

### Completion Notes List
- Implemented upload/list APIs with validation, storage, and error handling.
- Added Video entity/repository and upload size configuration.
- Added controller tests for upload and list scenarios.
- Updated upload status to READY, added MP4 signature check, and added pagination/sorting.
- Added storage IO failure and missing file tests.
- Added missing multipart file handling in error responses.

### File List
- backend/src/main/resources/application.yml
- backend/src/main/java/com/example/videodemo/VideodemoApplication.java
- backend/src/main/java/com/example/videodemo/config/StoragePathInitializer.java
- backend/src/main/java/com/example/videodemo/config/AppProperties.java
- backend/src/main/java/com/example/videodemo/entity/VideoStatus.java
- backend/src/main/java/com/example/videodemo/entity/Video.java
- backend/src/main/java/com/example/videodemo/repository/VideoRepository.java
- backend/src/main/java/com/example/videodemo/service/VideoService.java
- backend/src/main/java/com/example/videodemo/dto/VideoListItemDto.java
- backend/src/main/java/com/example/videodemo/dto/ApiError.java
- backend/src/main/java/com/example/videodemo/exception/ApiException.java
- backend/src/main/java/com/example/videodemo/controller/VideoController.java
- backend/src/main/java/com/example/videodemo/controller/ApiExceptionHandler.java
- backend/src/test/java/com/example/videodemo/controller/VideoControllerTest.java
- backend/src/test/java/com/example/videodemo/service/VideoServiceTest.java

## QA Results
 
- 2026-01-15 结论: CONCERNS
- 代码审阅满足 AC，但自动化测试未能运行：mvnw.cmd 报错无法设置 MAVEN_HOME。
- 验证: `.\mvnw.cmd -q test`

- 2026-01-15 复查结论: PASS
- 已重新运行测试并通过，上传与列表功能符合 AC，错误处理与持久化覆盖完备。
- 验证: `mvn -q test`

### Gate Status
Gate: PASS → docs/qa/gates/1.2-upload-api-and-metadata-persistence.yml
