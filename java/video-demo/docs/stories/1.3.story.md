# Story 1.3: HLS 分片处理与播放信息

## Status
Done

## Story
**As a** 使用者,
**I want** 视频在上传后被分片并可播放，
**so that** 我可以通过 HLS 流畅播放。

## Epic Context
Epic 1 目标是完成“基础架构与上传处理闭环”。本 Story 负责分片处理、状态更新与播放信息输出，形成“上传 → 分片 → 可播放”的闭环。[Source: docs/prd/epic-1-基础架构与上传处理闭环.md#epic-1-基础架构与上传处理闭环]

## Dependencies
依赖 Story 1.2 已完成上传接口与 Video 元数据落库。

## Acceptance Criteria
1. 上传完成后触发 JavaCV 异步分片处理，分片时长固定为 2 秒。
2. 成功后生成 `.m3u8` 与 `.ts` 文件并保存到本地目录。
3. 分片成功后状态更新为“上传完成”，失败则为“失败”并记录错误提示。
4. 提供视频详情接口，包含播放所需的 HLS 清单地址与状态。
5. 后端可通过静态资源或接口提供 HLS 文件访问。

## Tasks / Subtasks
- [x] Task 1 建模与持久化：实现 HlsPackage 实体与 Repository，字段与表结构对齐（AC:2,3）[Source: docs/architecture/data-models.md#hlspackage][Source: docs/architecture/database-schema.md#database-schema][Source: docs/architecture/backend-architecture.md#data-access-layer]
  - [x] Subtask 1.1 实体字段覆盖 manifestPath、segmentDir、segmentPattern、segmentDurationSeconds、segmentCount、totalDurationSeconds、generatedAt（AC:2,3）[Source: docs/architecture/data-models.md#hlspackage]
  - [x] Subtask 1.2 表名与字段映射到 `t_hls_packages` 结构（AC:2,3）[Source: docs/architecture/database-schema.md#database-schema]
- [x] Task 2 实现异步分片处理服务（AC:1,2,3）[Source: docs/architecture/components.md#video-processing-service][Source: docs/architecture/coding-standards.md#critical-fullstack-rules]
  - [x] Subtask 2.1 上传完成后触发 `process(videoId)` 异步处理（AC:1）[Source: docs/architecture/components.md#video-processing-service][Source: docs/architecture/core-workflows.md#core-workflows]
  - [x] Subtask 2.2 使用 JavaCV/FFmpeg 切片，分片时长读取 `APP_HLS_SEGMENT_SECONDS=2`，生成 `.m3u8` 与 `.ts`（AC:1,2）[Source: docs/architecture/development-workflow.md#required-environment-variables][Source: docs/architecture/tech-stack.md#tech-stack]
  - [x] Subtask 2.3 处理成功后写入 HlsPackage 并更新 Video.status=READY（AC:3）[Source: docs/architecture/components.md#video-processing-service][Source: docs/architecture/core-workflows.md#core-workflows]
  - [x] Subtask 2.4 处理失败时更新 Video.status=FAILED，写入 `errorCode=PROCESSING_FAILED` 与 `errorMessage` 并清理 HLS 目录（AC:3）[Source: docs/architecture/components.md#video-processing-service][Source: docs/architecture/error-handling-strategy.md#error-code-catalog]
- [x] Task 3 实现详情接口 `GET /api/videos/{id}` 返回播放信息（AC:4）[Source: docs/architecture/api-specification.md#endpoint-details][Source: docs/architecture/backend-architecture.md#controller-template]
  - [x] Subtask 3.1 返回字段：id、title、status、sizeBytes、createdAt、manifestUrl（AC:4）[Source: docs/architecture/api-specification.md#dto-definitions]
  - [x] Subtask 3.2 视频未就绪时返回 `HLS_NOT_READY`（AC:4）[Source: docs/architecture/api-specification.md#endpoint-details][Source: docs/architecture/error-handling-strategy.md#error-code-catalog]
- [x] Task 4 提供 HLS 静态资源访问映射（AC:5）[Source: docs/architecture/api-specification.md#media-url-mapping]
  - [x] Subtask 4.1 使用 ResourceHandler 将 `/media/**` 映射到 `${APP_STORAGE_ROOT}/`（AC:5）[Source: docs/architecture/api-specification.md#media-url-mapping]
- [x] Task 5 测试与验证（AC:1,3,4,5）[Source: docs/architecture/testing-strategy.md#testing-strategy]
  - [x] Subtask 5.1 Service/Controller 测试覆盖 READY/FAILED 状态更新、详情接口返回与 `HLS_NOT_READY`（AC:3,4）[Source: docs/architecture/testing-strategy.md#test-organization][Source: docs/architecture/error-handling-strategy.md#error-code-catalog]
  - [x] Subtask 5.2 本地验证 HLS 访问：`manifestUrl` 可直接访问（AC:5）[Source: docs/architecture/local-validation.md#hls-访问映射]

## Dev Notes
### Previous Story Insights
不适用：本 Story 不依赖前序实现的额外注意事项。

### Data Models
- HlsPackage 字段：videoId、manifestPath、segmentDir、segmentPattern、segmentDurationSeconds、segmentCount、totalDurationSeconds、generatedAt。[Source: docs/architecture/data-models.md#hlspackage]
- HlsPackage 与 Video 为 1:1 关系，切片完成后建立关联。[Source: docs/architecture/data-models.md#relationships]
- 路径与命名规则：`manifestPath=${APP_STORAGE_ROOT}/{videoId}/hls/index.m3u8`；`segmentDir=${APP_STORAGE_ROOT}/{videoId}/hls/`；`segmentPattern=seg_%05d.ts`。[Source: docs/architecture/api-specification.md#media-url-mapping][Source: docs/architecture/data-models.md#hlspackage]
- `t_hls_packages` 表结构：`video_id`（主键/外键）、`manifest_path`、`segment_dir`、`segment_pattern`、`segment_duration_seconds`、`segment_count`、`total_duration_seconds`、`generated_at`，外键级联删除。[Source: docs/architecture/database-schema.md#database-schema]
- Video 状态：`UPLOADING`/`READY`/`FAILED`，失败时记录 `errorCode/errorMessage`。[Source: docs/architecture/data-models.md#video]

### API Specifications
- `GET /api/videos/{id}` 返回 `manifestUrl` 与 `status`；未就绪返回 `HLS_NOT_READY`，不存在返回 `VIDEO_NOT_FOUND`。[Source: docs/architecture/api-specification.md#endpoint-details][Source: docs/architecture/error-handling-strategy.md#error-code-catalog]
- `manifestUrl` 规则：`http://localhost:8080/media/{videoId}/index.m3u8`。[Source: docs/architecture/api-specification.md#media-url-mapping]

### Component Specifications
- 视频处理服务：`process(videoId)` 异步切片并更新 Video/HlsPackage；失败需清理 HLS 目录与写入错误信息。[Source: docs/architecture/components.md#video-processing-service]

### File Locations
- 后端包路径：`backend/src/main/java/com/example/videodemo/`；资源目录 `backend/src/main/resources/`。[Source: docs/architecture/unified-project-structure.md#unified-project-structure]
- 后端分层目录：`controller/`、`service/`、`repository/`、`entity/`、`config/`。[Source: docs/architecture/backend-architecture.md#controllerroute-organization]

### Configuration
- HLS 切片时长：`APP_HLS_SEGMENT_SECONDS=2`。[Source: docs/architecture/development-workflow.md#required-environment-variables]
- 存储根目录：`APP_STORAGE_ROOT=./data/videos`，清单路径 `${APP_STORAGE_ROOT}/{videoId}/hls/index.m3u8`。[Source: docs/architecture/development-workflow.md#required-environment-variables][Source: docs/architecture/api-specification.md#media-url-mapping]

### Testing
- 后端测试目录：`backend/src/test/java/com/example/videodemo/`；使用 JUnit 5 + Spring Boot Test。[Source: docs/architecture/testing-strategy.md#test-organization]
- 仅需 Unit + Integration + 手工冒烟，不引入 E2E。[Source: docs/architecture/tech-stack.md#关键选型与推荐请确认]

### Technical Constraints
- 切片必须异步处理，上传接口仅负责入库与落盘。[Source: docs/architecture/coding-standards.md#critical-fullstack-rules]
- 失败响应必须返回 `{ error: { code, message } }`。[Source: docs/architecture/coding-standards.md#critical-fullstack-rules]
- 存储路径通过配置读取，不允许硬编码。[Source: docs/architecture/coding-standards.md#critical-fullstack-rules]
- 后端技术栈：Spring Boot 3.2.x + JPA + SQLite + Java 21；视频处理使用 JavaCV/FFmpeg。[Source: docs/architecture/tech-stack.md#technology-stack-table]

## Project Structure Notes
- 与 `Unified Project Structure` 对齐：`backend/`、`frontend/`、`data/`、`docs/` 与 `startup.sh` 已定义。[Source: docs/architecture/unified-project-structure.md#unified-project-structure]

## Change Log
| Date       | Version | Description       | Author |
| ---------- | ------- | ----------------- | ------ |
| 2026-01-15 | v0.4    | 补充分片触发与失败分支测试覆盖 | James  |
| 2026-01-15 | v0.3    | 实现 HLS 分片、详情接口与资源映射 | James  |
| 2026-01-15 | v0.2    | 补充分片路径与命名规则 | Bob    |
| 2026-01-15 | v0.1    | 创建 Story 1.3 草稿 | Bob    |

## Dev Agent Record
### Agent Model Used
GPT-5

### Debug Log References
- `mvn -q test`

### Completion Notes List
- 新增 HLS 分片实体与异步处理流程，成功/失败状态回写。
- 提供视频详情接口与静态资源映射，返回 manifestUrl。
- 补充分片与详情相关测试，并更新上传响应状态断言。
- 增加分片触发与分片时长配置测试，覆盖 FAILED 状态返回分支。

### File List
- backend/pom.xml
- backend/src/main/java/com/example/videodemo/VideodemoApplication.java
- backend/src/main/java/com/example/videodemo/config/AppProperties.java
- backend/src/main/java/com/example/videodemo/config/MediaResourceConfig.java
- backend/src/main/java/com/example/videodemo/controller/VideoController.java
- backend/src/main/java/com/example/videodemo/dto/VideoDetailDto.java
- backend/src/main/java/com/example/videodemo/entity/HlsPackage.java
- backend/src/main/java/com/example/videodemo/repository/HlsPackageRepository.java
- backend/src/main/java/com/example/videodemo/service/HlsSegmentResult.java
- backend/src/main/java/com/example/videodemo/service/HlsSegmenter.java
- backend/src/main/java/com/example/videodemo/service/JavaCvHlsSegmenter.java
- backend/src/main/java/com/example/videodemo/service/VideoProcessingService.java
- backend/src/main/java/com/example/videodemo/service/VideoService.java
- backend/src/main/resources/application.yml
- backend/src/test/java/com/example/videodemo/controller/VideoControllerTest.java
- backend/src/test/java/com/example/videodemo/service/VideoProcessingServiceTest.java
- backend/src/test/java/com/example/videodemo/service/VideoServiceTest.java
- backend/src/test/java/com/example/videodemo/support/RecordingHlsSegmenter.java
- backend/src/test/java/com/example/videodemo/support/TestHlsSegmenterConfig.java

## QA Results
### Review Date: 2026-01-15

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
实现结构清晰，分片流程、详情接口与静态资源映射符合要求。已执行 `mvn -q test`，测试通过。主要缺口在 AC1 的测试覆盖（上传触发异步分片与 2 秒分片时长验证）。

### Refactoring Performed
无。

### Compliance Check
- Coding Standards: ✅ 未发现硬编码存储路径，分片异步处理符合规范。
- Project Structure: ✅ 目录结构与分层一致。
- Testing Strategy: ✅ 单元/集成测试在 backend/src/test/java 组织。
- All ACs Met: ⚠️ 功能实现齐备，但 AC1 缺少针对触发/分片时长的测试验证。

### Improvements Checklist
- [ ] 为 AC1 补充上传触发异步分片与 2 秒分片时长的测试（建议覆盖 VideoService/VideoProcessingService）
- [ ] 可补充 FAILED 状态下详情接口返回 HLS_NOT_READY 的用例（非阻塞）

### Security Review
未发现明显安全问题；静态资源映射限定在存储根目录下。

### Performance Considerations
分片异步处理，避免阻塞上传请求；现有实现符合预期。

### Files Modified During Review
无。

### Gate Status
Gate: CONCERNS -> docs/qa/gates/1.3-hls-segmentation-and-playback-info.yml
Risk profile: 未生成
NFR assessment: 未生成

### Recommended Status
[ ] Ready for Done / [x] Changes Required - See unchecked items above

### Review Date: 2026-01-15

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
已补充异步分片触发与 2 秒分片时长验证测试，并覆盖 FAILED 状态详情接口分支；`mvn -q test` 通过。

### Refactoring Performed
无。

### Compliance Check
- Coding Standards: ✅ 符合异步处理与配置读取规范。
- Project Structure: ✅ 目录结构与分层一致。
- Testing Strategy: ✅ 新增测试位于 backend/src/test/java。
- All ACs Met: ✅ AC1~AC5 均有实现与测试覆盖。

### Improvements Checklist
- [x] 为 AC1 补充上传触发异步分片与 2 秒分片时长测试
- [x] 覆盖 FAILED 状态详情接口返回 `HLS_NOT_READY`

### Security Review
未发现明显安全问题；静态资源映射限定在存储根目录下。

### Performance Considerations
异步分片避免阻塞上传请求；当前实现符合预期。

### Files Modified During Review
无。

### Gate Status
Gate: PASS -> docs/qa/gates/1.3-hls-segmentation-and-playback-info.yml
Risk profile: 未生成
NFR assessment: 未生成

### Recommended Status
[x] Ready for Done / [ ] Changes Required - See unchecked items above
