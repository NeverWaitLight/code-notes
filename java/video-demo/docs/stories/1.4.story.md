# Story 1.4: 删除接口

## Status

Done

## Story

**As a** 使用者,
**I want** 删除已上传的视频，
**so that** 我可以清理不需要的内容。

## Epic Context

Epic 1 目标是完成“基础架构与上传处理闭环”。本 Story 负责删除接口与清理逻辑，确保视频与 HLS 产物可回收。[Source: docs/prd/epic-1-基础架构与上传处理闭环.md#epic-1-基础架构与上传处理闭环]

## Dependencies

依赖 Story 1.3 已完成 HLS 分片与详情接口。

## Acceptance Criteria

1. 提供删除接口，按视频 ID 删除数据库记录与本地文件（原始视频与 HLS 输出）。
2. 若文件或记录不存在，返回明确的错误提示。

## Tasks / Subtasks

- [x] Task 1 实现删除接口 `DELETE /api/videos/{id}`（AC:1,2）[Source: docs/architecture/api-specification.md#endpoint-details][Source: docs/architecture/backend-architecture.md#controller-template]
  - [x] Subtask 1.1 在 VideoController 添加 `@DeleteMapping("/{id}")` 方法，调用 VideoService.delete(id)（AC:1,2）[Source: docs/architecture/backend-architecture.md#controller-template]
  - [x] Subtask 1.2 在 VideoService 实现 delete(id) 方法：查询 Video，不存在返回 `VIDEO_NOT_FOUND`（AC:2）[Source: docs/architecture/error-handling-strategy.md#error-code-catalog]
  - [x] Subtask 1.3 查询 HlsPackage（可选），若存在则获取 segmentDir 用于删除 HLS 目录（AC:1）[Source: docs/architecture/data-models.md#relationships][Source: docs/architecture/data-models.md#hlspackage]
  - [x] Subtask 1.4 删除文件系统资源：先删除原始文件（Video.storagePath），再删除 HLS 目录（HlsPackage.segmentDir，如存在），使用 Files.deleteIfExists() 避免文件不存在时报错（AC:1）[Source: docs/architecture/data-models.md#video][Source: docs/architecture/data-models.md#hlspackage]
  - [x] Subtask 1.5 删除数据库记录：调用 repository.delete(video)，级联删除 HlsPackage（AC:1）[Source: docs/architecture/database-schema.md#database-schema]
  - [x] Subtask 1.6 文件删除异常处理：捕获 IOException，返回 `STORAGE_IO_ERROR` 并记录错误信息，但数据库记录仍尝试删除（AC:2）[Source: docs/architecture/error-handling-strategy.md#error-code-catalog]
  - [x] Subtask 1.7 成功删除返回 204 No Content（AC:1）[Source: docs/architecture/api-specification.md#endpoint-details]
- [x] Task 2 验证数据库级联删除配置（AC:1）[Source: docs/architecture/database-schema.md#database-schema]
  - [x] Subtask 2.1 确认 HlsPackage 实体外键配置 `@OnDelete(action = OnDeleteAction.CASCADE)` 或数据库外键约束 `ON DELETE CASCADE`（AC:1）[Source: docs/architecture/database-schema.md#database-schema]
- [x] Task 3 错误响应格式与状态码（AC:2）[Source: docs/architecture/error-handling-strategy.md#error-response-format][Source: docs/architecture/coding-standards.md#critical-fullstack-rules]
  - [x] Subtask 3.1 确保 ApiException 统一返回 `{ error: { code, message } }` 格式（AC:2）[Source: docs/architecture/error-handling-strategy.md#error-response-format]
  - [x] Subtask 3.2 状态码：VIDEO_NOT_FOUND 返回 404，STORAGE_IO_ERROR 返回 500（AC:2）[Source: docs/architecture/error-handling-strategy.md#error-code-catalog]
- [x] Task 4 测试与验证（AC:1,2）[Source: docs/architecture/testing-strategy.md#testing-strategy]
  - [x] Subtask 4.1 单元测试 VideoService.delete()：覆盖删除成功、Video 不存在、文件删除失败场景（AC:1,2）[Source: docs/architecture/testing-strategy.md#test-organization]
  - [x] Subtask 4.2 集成测试 VideoController：覆盖删除成功返回 204、VIDEO_NOT_FOUND 返回 404、STORAGE_IO_ERROR 返回 500（AC:1,2）[Source: docs/architecture/testing-strategy.md#test-organization][Source: docs/architecture/error-handling-strategy.md#error-code-catalog]
  - [x] Subtask 4.3 边界测试：Video 存在但 HlsPackage 缺失时仍能成功删除 Video 和原始文件（AC:1）[Source: docs/architecture/data-models.md#relationships]
  - [x] Subtask 4.4 验证级联删除：删除 Video 后确认 HlsPackage 记录也被删除（AC:1）[Source: docs/architecture/database-schema.md#database-schema][Source: docs/architecture/local-validation.md#jpa--sqlite]

## Dev Notes

### Previous Story Insights

- Story 1.3 已实现 HlsPackage 实体与 Repository，删除时需查询 HlsPackage 获取 segmentDir。[Source: docs/stories/1.3.story.md#dev-agent-record]
- VideoService 已有 resolveStoragePath() 方法用于构建存储路径，删除时可直接使用 Video.storagePath。[Source: backend/src/main/java/com/example/videodemo/service/VideoService.java]
- 存储根目录通过 AppProperties.getStorageRoot() 读取，删除文件时需确保路径解析正确。[Source: docs/architecture/development-workflow.md#required-environment-variables]

### Data Models

- Video 字段包含 `storagePath`（完整路径如 `./data/videos/{id}/normal_video.mp4`）；删除需清理原始文件。[Source: docs/architecture/data-models.md#video]
- HlsPackage 字段包含 `segmentDir`（如 `./data/videos/{id}/hls/`）与 `manifestPath`，用于定位 HLS 目录；删除时需删除整个 segmentDir 目录及其内容。[Source: docs/architecture/data-models.md#hlspackage]
- HlsPackage 仅在切片完成时存在（status=READY），UPLOADING 或 FAILED 状态可能无 HlsPackage；删除时需处理 HlsPackage 缺失的情况。[Source: docs/architecture/data-models.md#relationships]
- `t_hls_packages` 外键对 `t_videos` 级联删除，删除 Video 时 HlsPackage 会自动删除；但文件系统资源需手动清理。[Source: docs/architecture/database-schema.md#database-schema]

### API Specifications

- `DELETE /api/videos/{id}` 成功返回 204 No Content（无响应体）；找不到返回 404 `VIDEO_NOT_FOUND`；文件系统错误返回 500 `STORAGE_IO_ERROR`。[Source: docs/architecture/api-specification.md#endpoint-details][Source: docs/architecture/error-handling-strategy.md#error-code-catalog]
- 错误响应格式：`{ error: { code, message, timestamp?, requestId? } }`，使用 ApiException 统一处理。[Source: docs/architecture/error-handling-strategy.md#error-response-format]
- 删除操作应具有幂等性：重复删除已不存在的视频应返回 404 而非 204（通过查询数据库判断是否存在）。[Source: docs/architecture/api-specification.md#endpoint-details]

### Component Specifications

- 控制器与服务位置：`controller/VideoController.java`、`service/VideoService.java`；仓库 `repository/VideoRepository.java`、`HlsPackageRepository.java`。[Source: docs/architecture/backend-architecture.md#controllerroute-organization]
- VideoService.delete(id) 方法实现删除逻辑：查询 Video → 查询 HlsPackage（可选）→ 删除文件系统资源 → 删除数据库记录。[Source: docs/architecture/backend-architecture.md#controller-template]
- 文件删除使用 `java.nio.file.Files` API：`Files.deleteIfExists(Path)` 删除文件，`Files.walkFileTree()` 或递归删除目录。[Source: docs/architecture/core-workflows.md#core-workflows]

### File Locations

- 后端包路径：`backend/src/main/java/com/example/videodemo/`；资源目录 `backend/src/main/resources/`。[Source: docs/architecture/unified-project-structure.md#unified-project-structure]
- 后端分层目录：`controller/`、`service/`、`repository/`、`entity/`、`config/`。[Source: docs/architecture/backend-architecture.md#controllerroute-organization]

### Configuration

- 存储根目录：`APP_STORAGE_ROOT=./data/videos`，删除时按存储路径清理原始文件与 HLS 目录。[Source: docs/architecture/development-workflow.md#required-environment-variables]

### Testing

- 后端测试目录：`backend/src/test/java/com/example/videodemo/`；使用 JUnit 5 + Spring Boot Test。[Source: docs/architecture/testing-strategy.md#test-organization]
- 仅需 Unit + Integration + 手工冒烟，不引入 E2E。[Source: docs/architecture/tech-stack.md#关键选型与推荐请确认]
- 测试数据准备：使用 `@DirtiesContext` 或测试后清理，避免测试间相互影响。[Source: docs/architecture/testing-strategy.md#test-organization]
- Mock 文件系统操作：单元测试可使用 `@MockBean` 或临时目录，集成测试使用真实文件系统但需清理。[Source: docs/architecture/testing-strategy.md#test-organization]

### Technical Constraints

- 错误格式必须返回 `{ error: { code, message } }`，使用 ApiException 统一抛出。[Source: docs/architecture/coding-standards.md#critical-fullstack-rules]
- 存储路径通过配置读取，不允许硬编码；使用 AppProperties.getStorageRoot() 获取根目录。[Source: docs/architecture/coding-standards.md#critical-fullstack-rules]
- 文件删除操作需处理并发安全：删除过程中其他请求不应访问该视频资源。[Source: docs/architecture/coding-standards.md#critical-fullstack-rules]
- 删除顺序：先删除文件系统资源，再删除数据库记录；若文件删除失败，仍尝试删除数据库记录（避免孤立记录）。[Source: docs/architecture/core-workflows.md#core-workflows]
- 目录删除需递归删除所有子文件和子目录，使用 `Files.walkFileTree()` 或 Apache Commons IO `FileUtils.deleteDirectory()`。[Source: docs/architecture/core-workflows.md#core-workflows]

## Project Structure Notes

- 与 `Unified Project Structure` 对齐：`backend/`、`frontend/`、`data/`、`docs/` 与 `startup.sh` 已定义。[Source: docs/architecture/unified-project-structure.md#unified-project-structure]

## Change Log

| Date       | Version | Description                                        | Author |
| ---------- | ------- | -------------------------------------------------- | ------ |
| 2026-01-15 | v0.6    | QA 审查通过，Gate 状态为 PASS，状态更新为 Done     | Quinn  |
| 2026-01-15 | v0.5    | 实现完成，所有任务和测试通过，状态更新为 Ready for Review | James  |
| 2026-01-15 | v0.4    | 验证通过，状态更新为 Ready for Development        | Sarah  |
| 2026-01-15 | v0.3    | 完善删除逻辑细节、文件操作顺序、错误处理与测试场景 | Bob    |
| 2026-01-15 | v0.2    | 补充删除边界行为与测试覆盖                         | Bob    |
| 2026-01-15 | v0.1    | 创建 Story 1.4 草稿                                | Bob    |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5

### Debug Log References

mvn test -Dtest=VideoServiceTest#delete*,VideoControllerTest#delete* - 所有删除相关测试通过
mvn test - 完整测试套件通过，26 个测试全部通过

### Completion Notes List

实现了 DELETE /api/videos/{id} 删除接口
在 VideoController 添加了 @DeleteMapping("/{id}") 方法，返回 204 No Content
在 VideoService 实现了 delete(id) 方法，包含完整的删除逻辑
删除逻辑：查询 Video → 查询 HlsPackage（可选）→ 删除文件系统资源（原始文件和 HLS 目录）→ 删除数据库记录
文件删除使用 Files.deleteIfExists() 和 Files.walk() 递归删除目录
错误处理：Video 不存在返回 404 VIDEO_NOT_FOUND，文件删除失败返回 500 STORAGE_IO_ERROR
级联删除：手动删除 HlsPackage 后删除 Video，确保数据库记录正确清理
添加了完整的单元测试和集成测试，覆盖所有场景
所有测试通过，包括边界情况和级联删除验证

### File List

backend/src/main/java/com/example/videodemo/controller/VideoController.java - 添加 DELETE 端点
backend/src/main/java/com/example/videodemo/service/VideoService.java - 实现 delete 方法
backend/src/test/java/com/example/videodemo/service/VideoServiceTest.java - 添加删除相关单元测试
backend/src/test/java/com/example/videodemo/controller/VideoControllerTest.java - 添加删除相关集成测试

## QA Results

### Review Date: 2026-01-15

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

实现质量良好，删除接口逻辑完整且符合架构规范。代码遵循了错误处理策略，文件删除顺序合理（先删除文件系统资源，再删除数据库记录），错误处理完善。级联删除通过手动删除 HlsPackage 实现，虽然数据库层面有 CASCADE 约束，但代码层面的显式删除更加安全和可控。

### Refactoring Performed

未进行重构。代码质量已达到标准，无需修改。

### Compliance Check

- Coding Standards: ✓ 符合编码规范，错误格式统一使用 ApiException，存储路径通过配置读取
- Project Structure: ✓ 文件位置符合统一项目结构
- Testing Strategy: ✓ 测试覆盖完整，包含单元测试和集成测试，符合测试策略要求
- All ACs Met: ✓ 所有验收标准均已实现并通过测试验证

### Improvements Checklist

- [x] 验证删除接口实现完整性
- [x] 验证错误处理符合规范
- [x] 验证测试覆盖所有场景
- [x] 验证级联删除逻辑正确
- [x] 验证文件删除顺序合理
- [ ] 考虑添加删除操作的权限检查（如需要）
- [ ] 考虑添加删除操作的审计日志（如需要）

### Security Review

删除接口未实现权限检查，但考虑到这是内部 API 且当前项目阶段，可以接受。建议在生产环境前添加适当的权限验证机制。

### Performance Considerations

文件删除操作（特别是递归删除 HLS 目录）可能较慢，但这是合理的。对于大文件或大量分段，删除操作可能需要较长时间，但当前实现已经正确处理了这种情况。

### Files Modified During Review

未修改任何文件。

### Gate Status

Gate: PASS → docs/qa/gates/1.4-删除接口.yml

### Recommended Status

✓ Ready for Done
